var message = {
	"valid": {
		"qq": "properties.qq",
		"integerPrecision": "properties.integerPrecision",
		"compare": "properties.compare",
		"datetime": "properties.datetime",
		"maxlength": "请不要超过{0}个字符",
		"fractionPrecision": "properties.fractionPrecision",
		"series": "properties.series",
		"pattern": "properties.pattern",
		"cellphone": "properties.cellphone",
		"bankcard": "properties.bankcard",
		"required": "该字段不能为空"
	},
	"common": {
		"daterange.LastWeek": "上周",
		"save.success": "保存成功!",
		"save.failed": "保存失败!",
		"online.message.error": "在线消息服务连接异常！",
		"daterange.Today": "今天",
		"repeat.request.error": "请不要重复提交数据",
		"daterange.Last7Days": "最近7天",
		"daterange.ThisWeek": "本周",
		"daterange.Yesterday": "昨天",
		"daterange.TheDayBeforeYesterday": "前天",
		"daterange.ThisMonth": "本月",
		"daterange.LastMonth": "上月",
		"server.error": "服务忙,请重新操作!",
		"daterange.Last30Days": "最近30天",
		"OK": "确定"
	},
	"passport": {
		"authenticationFailure.AccountPasswordException": "账号或密码错误！",
		"authenticationFailure.CredentialExpiredException": "密码过期！",
		"authenticationFailure.AccountLockedException": "账号被冻结",
		"defense.register.disable.hours": "您注册的太频繁了，请于{0}小时后再来！",
		"authenticationFailure.InvalidLoginTimeException": "账号本时段被禁止登录！",
		"required.password": "请输入密码！",
		"notice.param.customer": "联系客服",
		"gameLogin.notGameLogin": "当前游戏已下架，去看看别的游戏吧！",
		"authenticationFailure.AccountDisabledException": "账号被停用",
		"authenticationFailure.InvalidLoginLocationException": "账号被禁止从当前地址登录！",
		"kick.out.manual.title": "强制踢出",
		"register.ip.restrict": "您所在的IP今天已经注册满员啦，明天再来吧！",
		"defense.register.disable.hours.24": "您所在的IP今天已经注册满员啦，请明天再来！",
		"freeznReason.title": "您的账户由于异常操作已被冻结，暂不支持登录！",
		"authenticationFailure.UNKNOWN": "登录失败！",
		"freeznReason.content": "您的登录密码输入错误次数超过上限，账户已被系统临时冻结，{0}解冻后将恢复正常登录。您也可以重置登录密码解冻。如有疑问，请{1}处理！",
		"required.username": "请输入账号！",
		"authenticationFailure.AccountNotFoundException": "账号或密码错误！",
		"authenticationFailure.AccountInActiveException": "账号审核中，稍后再试！",
		"kick.out.manual.content": "当前您的账号已由系统管理员强制下线。如有任何疑问，请及时联系在线客服。",
		"kick.out.auto.title": "重复登录",
		"authenticationFailure.captcha": "\"验证码不正确!\"",
		"authenticationFailure.remainTimes": "还可输入{0}次",
		"authenticationFailure.accountLockMaxTimes": "因于您的登录密码输入错误次数达到{0}次，账号已被系统临时冻结{1}小时!",
		"required.captcha": "请输入验证码！",
		"kick.out.auto.content": "当前您的账号在另一个地点登录，您已被迫下线，该地点IP为{0}。若这不是您本人操作，很可能您的密码已经泄露，建议您立即修改密码。如有任何疑问，请及时联系在线客服！"
	},
	"Register": {
		"constellation.notBlank": "星座不能为空",
		"username.exist": "用户名已经存在",
		"phone.format": "格式不正确，请输入纯数字",
		"realname.format": "请输入2-30个字符（由汉字、大小写英文字母、“·”组成）",
		"username.notBlank": "用户名不能为空",
		"captchaCode.notBlank": "验证码不能为空",
		"answer.notBlank": "回答不能为空",
		"weixin.notBlank": "请输入微信号",
		"username.format": "请输入4-15个字符（由英文字母，下划线“-”，数字或任意组合而成）",
		"weixin.format": "微信号格式不对，2-20个字符，类型不限",
		"permissionPwd.noBlank": "安全密码不能为空",
		"qq.notBlank": "请输入您的QQ账号",
		"termsOfService.notBlank": "请同意服务条款",
		"nickname.format": "请输入3-15个字符（由汉字、大小写英文字母和数字组成）",
		"email.format": "格式不正确，请输入有效的携带@符号的后缀",
		"region.notBlank": "省不能为空",
		"skype.notBlank": "请输入您的Skype账号",
		"password.notBlank": "登录密码不能为空",
		"sex.notBlank": "性别不能为空",
		"confirmPassword.notBlank": "确认登录密码不能为空",
		"email.notBlank": "请输入邮箱地址",
		"recomendUser.notBlank": "介绍人不能为空",
		"qq.format": "请输入5~11位0-9的纯数字",
		"msn.format": "格式不正确，请重新输入",
		"permissionPwd.format": "请选择6位0-9的纯数字",
		"defaultLocale.notBlank": "主语言不能为空",
		"recomendUser.format": "请输入正确的介绍人邀请码",
		"city.notBlank": "市不能为空",
		"realname.notBlank": "请输入真实姓名",
		"defaultTimezone.notBlank": "时区不能为空",
		"phone.notBlank": "请输入手机号码",
		"skype.format": "格式不正确，请重新输入",
		"password.format": "请输入6-20个字符（由大小写英文字母、数字和特殊符号组成）",
		"msn.notBlank": "请输入您的MSN账号",
		"country.notBlank": "国家不能为空",
		"confirmPassword.notEqWithPassword": "两次输入的不一致",
		"defaultCurrency.notBlank": "主货币不能为空",
		"confirmPermissionPwd.notEqWithPermissionPwd": "两次输入的不一致",
		"answer.format": "请输入1-30字符",
		"question.notBlank": "问题不能为空",
		"nickname.notBlank": "昵称不能为空",
		"captchaCode.notRight": "请输入正确的验证码",
		"confirmPermissionPwd.notBlank": "确认安全密码不能为空"
	},
	"log": {
		"passport.logout.desc.success": "退出成功!",
		"passport.login.desc.fail": "登录失败!",
		"passport.login.desc.success": "登录成功!"
	},
	"privilege": {
		"input.success": "输入正确！",
		"input.wrong": "密码错误，请重试！",
		"exist.user": "要删除角色存在关联用户，不能删除",
		"captcha.wrong": "您输入的验证码不正确，请重新输入!",
		"privilege.setpermissionPwd": "设置安全密码",
		"privilege.code.notblank": "请输入安全密码！",
		"title": "安全密码",
		"input.freeze": "密码输错已达上限被暂时冻结3小时，可重置密码后再操作",
		"permissionPwdNeConfirm": "两次输入的安全密码不一致",
		"captcha.input": "请输入验证码!",
		"privilege.valiCode.notblank": "请输入验证码！"
	},
	"subAccount": {
		"role.resourceIdNotNull": "请选择权限",
		"role.nameEmpty": "角色名称不能为空",
		"role.delete": "当前角色共有{x}个子账号正在使用，确认删除吗？",
		"edit.emailLen": "邮箱应该在128字符以内",
		"role.resource": "角色权限管理",
		"delete.confirmMessage": "确认删除该子账号吗？",
		"delete.confirmMessageUsing": "有子账号正在使用，确认删除吗？",
		"edit.question": "问题不能为空",
		"role.deleteConfirm": "确定删除该角色模板吗?",
		"role.rename": "角色名称:",
		"edit.confirmPasswordNE": "两次输入的登录密码不一致",
		"edit.email": "请填写正确的邮箱地址，以便接收信息。",
		"edit.usernameExist": "用户名已经存在",
		"edit.confirmPermissionPwdNe": "两次输入的安全密码不一致",
		"delete.confirmMessageBuiltin": "账号包含系统默认的重要角色，确认删除吗？",
		"edit.memoMax1000": "备注最长1000字符"
	},
	"notice": {
		"tmpl.content.BIND_EMAIL_VERIFICATION_CODE": "<p>亲爱的用户，您好：</p><p>   感谢您使用${sitename}！您正在进行邮箱验证，本次请求的验证码为：<strong>${verificationCode}</strong>。请将此验证码填入验证框内，以完成验证！</p><p>   本邮件为系统自动发出，请勿直接回复！如有疑问，请联系<a href=\"${customer}\" target=\"_blank\">在线客服</a>。</p><p> ${sitename}</p><p> ${year}年${month}月${day}日</p><p><br/></p>",
		"tmpl.title.BIND_EMAIL_VERIFICATION_CODE": "${sitename}验证码"
	},
	"setting": {
		"notice.param.customer": "联系客服"
	}
}
var emailCheckCountBackTimer;
var PASSWORD_LEVEL_1 = new RegExp("^[a-zA-Z]+$");
var PASSWORD_LEVEL_2 = new RegExp("^[0-9]+$");
var PASSWORD_LEVEL_3 = new RegExp("^[0-9a-zA-Z]+$");
var PASSWORD_LEVEL_4 = new RegExp("^[A-Za-z0-9~!@#$%^&*()_+\\{\\}\\[\\]|\\:;\'\"<>,./?]+$");
$(function() {
	disableLogin();
	initFormDataAndValid();
	initCountryArea();
	initBirthData();
	var captchaObj = $("._vr_captcha_code", "#regForm");
	$(captchaObj).attr("src", "/pcenter/captcha/" + $(captchaObj).data("code") + ".html?t=" + new Date().getTime().toString(36));
	resetLocal()
});

function disableLogin() {
	$(".inputMailList").mailAutoComplete();
	$("#unLogin").hide();
}
$(".loginNow").on("click", function() {
	loginObj.getLoginPopup(function() {
		window.location.href = "/";
	});
});

function validateCellPhone(obj) {
	var sendPhoneIntervalSeconds = 60;
	var $this = $(obj);
	var $phone = $('[name="phone.contactValue"]');
	var phone = $phone.val();
	var cookie = getCookie(REGSTER_SEND_PHONE_TIME);
	cookie = Number(cookie);
	if (!phone) {
		BootstrapDialog.alert({
			message: '请先输入手机号！',
			title: '提示信息'
		});
		return;
	} else if ($phone.parents(".form-group").hasClass("has-error")) {
		BootstrapDialog.alert({
			message: '请输入正确的手机号！',
			title: '提示信息'
		});
		return;
	} else if (cookie) {
		BootstrapDialog.alert({
			message: '发送间隔时间未到！',
			title: '提示信息'
		});
		return;
	}
	if (phone && !cookie) {
		$.ajax({
			url: "/verificationCode/getPhoneVerificationCode.html",
			type: "POST",
			dataType: 'json',
			data: {
				"phone": phone
			},
			success: function(data) {
				if (data) {
					setCookie(REGSTER_SEND_PHONE_TIME, sendPhoneIntervalSeconds);
					phoneCheckCountBackTimer = setInterval(function() {
						var sendPhoneIntervalSec = getCookie(REGSTER_SEND_PHONE_TIME);
						sendPhoneIntervalSec = Number(sendPhoneIntervalSec);
						sendPhoneIntervalSec = --sendPhoneIntervalSec;
						if (!sendPhoneIntervalSec) {
							clearInterval(phoneCheckCountBackTimer);
							$this.prop("disabled", false);
							$this.text("重新发送")
						} else {
							$this.prop("disabled", true);
							$this.text(sendPhoneIntervalSec + "秒后重新发送")
						}
						setCookie(REGSTER_SEND_PHONE_TIME, sendPhoneIntervalSec);
					}, 1000)
				}
			},
			error: function(error) {}
		})
	}
}
$("[name='sysUser.defaultTimezone']").on("change", function() {
	var $this = $(this);
	var value = $this.val();
	if (value) {
		$.ajax({
			url: "register/getDateByTimezone.html",
			data: {
				"sysUser.defaultTimezone": value,
			},
			type: "POST",
			success: function(data) {
				$("._showDateByTimezone").show().children().text(value + " " + data);
			},
			error: function(error) {}
		})
	}
});
$('.noCp').bind("cut copy paste", function(e) {
	e.preventDefault();
});
$("[name='sysUser.password']").on("keyup", function() {
	setTimeout(changePassowrdLevel, $.validator.defaults.keypressDelay + 500)
});
$("[data-rel]").on("change", function(e) {
	var $this = $(this);
	var name = $this.prop("name");
	var url;
	if (name === "sysUser.country") {
		url = "regions/states/" + $('select[name="sysUser.country"]').val() + ".html";
	} else if (name === "sysUser.region") {
		url = "regions/cities/" + $('select[name="sysUser.country"]').val() + "-" + $('select[name="sysUser.region"]').val() + ".html"
	}
	getSelectData(url, "select[name='" + $this.data().rel + "']");
});
$("[name=termsOfServiceCheck]").on('click', function() {
	var $this = $(this);
	if ($this.is(':checked')) {
		$("[name=termsOfService]").val("true");
	} else {
		$("[name=termsOfService]").val("");
	}
});
$("#login-agreement").on("click", function() {
	BootstrapDialog.show({
		title: '会员注册协议',
		type: BootstrapDialog.TYPE_WARNING,
		closable: false,
		message: function(dialog) {
			var $message = $('<div class="agreement" style="overflow-y: auto; height: 600px;"></div>');
			var pageToLoad = dialog.getData('pageToLoad');
			$message.load(pageToLoad);
			return $message;
		},
		buttons: [{
			label: '我不同意',
			action: function() {
				window.location = "/";
			}
		}, {
			label: '我同意',
			cssClass: 'btn-info',
			action: function(dialogItself) {
				dialogItself.close();
			}
		}],
		data: {
			'pageToLoad': '/commonPage/modal/system-agreement.html'
		}
	});
});
$('[name=birthdayMon],[name=birthdayYear]').on("change", function() {
	var $birthdayMon = $("[name=birthdayMon]");
	var $birthdayYear = $("[name=birthdayYear]");
	if ($birthdayMon.val() && $birthdayYear.val()) {
		var days = new Date(Number($birthdayYear.val()), Number($birthdayMon.val()), 0).getDate();
		var html = [];
		for (var i = 1; i <= days; i++) {
			html.push("<option value='" + i + "'>" + i + "日</option>");
		}
		$("[name=birthdayDay]").html(html);
	}
});
$("[name='sysUser.permissionPwd']") && $("[name='sysUser.permissionPwd']").on("blur", function() {
	var pwdObj = $("[name='sysUser.password']");
	var tipObj = $(".permitPwdTip");
	if ($(this).val() == $(pwdObj).val()) {
		tipObj.show();
	} else {
		tipObj.hide();
	}
});

function changePassowrdLevel() {
	var $this = $("[name='sysUser.password']");
	var $parent = $this.parents(".form-group");
	var level = 0;
	var value = $this.val();
	if (!$parent.hasClass("has-error")) {
		if (PASSWORD_LEVEL_1.test(value) || PASSWORD_LEVEL_2.test(value)) {
			level = 1;
		} else if (PASSWORD_LEVEL_3.test(value)) {
			level = 2;
		} else if (PASSWORD_LEVEL_4.test(value)) {
			level = 3;
		}
		$("[name='sysUser.passwordLevel']").val(level * 10);
	}
	$("._password_level", $parent).find('[password-level]').hide().eq(level).show();
}

function initFormDataAndValid() {
	var $form = $('#regForm');
	var rule;
	var $ruleDiv = $form.find('div[id=validateRule]');
	if ($ruleDiv.length > 0) {
		rule = eval("({" + $ruleDiv.text() + "})");
		rule.ignore = ".ignore";
	}
	if (rule) {
		if ($.data($form[0], "validator")) {
			$.data($form[0], "validator", null);
		}
		$form.validate(rule);
	}
	$.ajax({
		url: "register/getRegisterData.html?c=" + getRecCode(),
		type: "GET",
		success: function(data) {
			data = eval('(' + data + ')');
			$("[name='sysUser.defaultCurrency']").val(data.currency);
			$("[name='sysUser.defaultTimezone']").val(data.timezone);
			if (data.ipLocale) {
				data.ipLocale.country && $("[name='sysUser.country']").val(data.ipLocale.country).change();
				data.ipLocale.region && $("[name='sysUser.region']").val(data.ipLocale.region).change();
				data.ipLocale.city && $("[name='sysUser.city']").val(data.ipLocale.city).change();
			}
			var $recommendBox = $("#recommendBox");
			if (data.recommendCode || getRecCode() != "") {
				$recommendBox.show();
				$("input", $recommendBox).val(data.recommendCode ? data.recommendCode : getRecCode()).attr("disabled", "disabled");
				$('#recommendRegisterCode').val(data.recommendCode ? data.recommendCode : getRecCode());
			}
		}
	});
}

function getRecCode() {
	var recCode = "";
	if (getlocationParam('registeredCode') != null) {
		recCode = getlocationParam('registeredCode');
	} else if (getlocationParam('c') != null) {
		recCode = getlocationParam('c');
	}
	return recCode;
}

function initCountryArea() {
	$("select[name='sysUser.country']").length && getSelectData($("select[name='sysUser.country']").data().ajax, "select[name='sysUser.country']");
}

function getSelectData(url, Selector) {
	$.ajax({
		url: url,
		dataType: 'JSON',
		cache: false,
		type: "GET",
		success: function(data) {
			createSelect(data, Selector)
		},
	});
}

function createSelect(data, selector) {
	var html = '<option value="">请选择</option>';
	$.each(data, function(i, item) {
		html += "<option value='" + item.dictCode + "'> " + item.remark + "</option>";
	});
	$(selector).html(html);
}

function registerPlayer(obj) {
	var $this = $(obj);
	var $form = $this.parents("form");
	if ($form.valid()) {
		var permissionPwd = '';
		$('._permissionPwd').each(function() {
			permissionPwd += $(this).val();
		});
		var $disabled = $(":disabled", $form);
		$disabled.removeAttr('disabled');
		var ajaxData = $form.serialize();
		$disabled.attr("disabled", "disabled");
		$.ajax({
			url: "register/playerRegister.html",
			type: "POST",
			dataType: 'json',
			data: ajaxData,
			beforeSend: function() {
				$this.attr("disabled", "disabled");
				$this.text("提交中...");
			},
			success: function(data) {
				if (data.status) {
					setCookie(REGSTER_SEND_EMAIL_TIME, 0);
					clearInterval(emailCheckCountBackTimer);
					autoLogin();
				} else {
					alert(data.msg);
					$this.removeAttr("disabled").text("提交注册");
				}
			},
			error: function(msg) {
				$this.removeAttr("disabled").text("提交注册");
				alert(msg.responseText);
			},
			complete: function() {}
		})
	}
}

function initBirthData() {
	var date = new Date();
	var currentYear = date.getYear() + 1900 - 18;
	var years = currentYear;
	for (; currentYear > years - 100; currentYear--) {
		$('[name=birthdayYear]').append('<option value="' + currentYear + '">' + (currentYear) + '年</option>')
	}
}

function validateEmailAddress(obj) {
	var sendEmailIntervalSeconds = 60;
	var $this = $(obj);
	var $email = $('[name="email.contactValue"]');
	var email = $email.val();
	var cookie = getCookie(REGSTER_SEND_EMAIL_TIME);
	cookie = Number(cookie);
	if (!email) {
		BootstrapDialog.alert({
			message: '请先输入邮箱！',
			title: '提示信息'
		});
		return;
	} else if ($email.parents(".form-group").hasClass("has-error")) {
		BootstrapDialog.alert({
			message: '请输入正确的邮箱！',
			title: '提示信息'
		});
		return;
	} else if (cookie) {
		BootstrapDialog.alert({
			message: '发送间隔时间未到！',
			title: '提示信息'
		});
		return;
	}
	if (email && !cookie) {
		var locale = $("[name='sysUser.defaultLocale']").val();
		$.ajax({
			url: "register/checkEmail.html",
			type: "POST",
			dataType: 'json',
			data: {
				"email": email,
				"locale": typeof locale === 'undefined' ? '' : locale
			},
			success: function(data) {
				if (data) {
					setCookie(REGSTER_SEND_EMAIL_TIME, sendEmailIntervalSeconds);
					emailCheckCountBackTimer = setInterval(function() {
						var sendEmailIntervalSec = getCookie(REGSTER_SEND_EMAIL_TIME);
						sendEmailIntervalSec = Number(sendEmailIntervalSec);
						sendEmailIntervalSec = --sendEmailIntervalSec;
						if (!sendEmailIntervalSec) {
							clearInterval(emailCheckCountBackTimer);
							$this.prop("disabled", false);
							$this.text("重新发送")
						} else {
							$this.prop("disabled", true);
							$this.text(sendEmailIntervalSec + "秒后重新发送")
						}
						setCookie(REGSTER_SEND_EMAIL_TIME, sendEmailIntervalSec);
					}, 1000)
				}
			},
			error: function(error) {}
		})
	}
}

function autoLogin() {
	var username = $("[name='sysUser.username']").val();
	var password = $("[name='sysUser.password']").val();
	$.ajax({
		type: "POST",
		headers: {
			"Soul-Requested-With": "XMLHttpRequest"
		},
		url: "passport/login.html",
		dataType: 'JSON',
		data: {
			'username': username.toLowerCase(),
			'password': password
		},
		success: function(data) {
			if (data.success) {
				window.location.href = "/";
			} else {
				window.location.href = "/";
			}
		},
		error: function(data) {}
	});
}

function resetLocal() {
	var currentLocal = "zh_CN";
	$("[name='sysUser.defaultLocale']").val(currentLocal);
}